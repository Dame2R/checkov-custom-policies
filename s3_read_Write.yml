metadata:
  name: "Ensure S3 buckets do not grant read/write to AllUsers or AuthenticatedUsers"
  id: "CKV_AWS_CUSTOM_004"
  category: "storage"
  description: "S3 buckets should not have ACLs that allow read/write to AllUsers or AuthenticatedUsers, or contain identities from other AWS accounts."
  guidelines: "ACLs that grant permissions to AllUsers or AuthenticatedUsers can lead to unintended data exposure. Ensure that your S3 bucket ACLs restrict access appropriately. For more information, refer to the AWS documentation on S3 bucket ACLs: https://docs.aws.amazon.com/AmazonS3/latest/userguide/acl-overview.html"
  severity: "HIGH"

scope:
  provider: "aws"

definition:
  cond_type: "attribute"
  resource_types:
    - "AWS::S3::Bucket"
  attribute: "AccessControl"
  operator: "not_equals"
  value: "PublicRead"
  value1: "PublicReadWrite"
  value2: "AuthenticatedRead"

policy:
  - rule_id: "CKV_AWS_CUSTOM_004"
    conditions:
      - and:
          - "resource_type == AWS::S3::Bucket"
          - "attribute.AccessControl != 'PublicRead'"
          - "attribute.AccessControl != 'PublicReadWrite'"
          - "attribute.AccessControl != 'AuthenticatedRead'"
    actions:
      - block
    recommended_actions:
      - "Modify the S3 bucket ACL to remove permissions for AllUsers and AuthenticatedUsers, and ensure no cross-account access is allowed unless explicitly required."
